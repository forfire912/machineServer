apiVersion: apps/v1
kind: Deployment
metadata:
  name: machineserver
  labels:
    app: machineserver
spec:
  replicas: 3
  selector:
    matchLabels:
      app: machineserver
  template:
    metadata:
      labels:
        app: machineserver
    spec:
      containers:
      - name: machineserver
        image: machineserver:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        env:
        - name: GIN_MODE
          value: "release"
        volumeMounts:
        - name: config
          mountPath: /root/configs
        - name: data
          mountPath: /root/data
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: machineserver-config
      - name: data
        persistentVolumeClaim:
          claimName: machineserver-data
---
apiVersion: v1
kind: Service
metadata:
  name: machineserver
  labels:
    app: machineserver
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
    name: http
  - port: 9090
    targetPort: 9090
    protocol: TCP
    name: metrics
  selector:
    app: machineserver
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: machineserver-config
data:
  config.yaml: |
    server:
      host: "0.0.0.0"
      port: 8080
      mode: "release"
    log:
      level: "info"
      file: "logs/server.log"
      max_size: 100
      max_backups: 3
      max_age: 28
    database:
      driver: "sqlite"
      dsn: "data/machineserver.db"
    redis:
      host: "redis"
      port: 6379
      password: ""
      db: 0
    auth:
      enabled: true
      jwt_secret: "change-this-in-production"
      token_expire: 24h
      api_keys:
        - "prod-key-change-me"
    backends:
      qemu:
        enabled: true
        binary: "qemu-system-arm"
        default_machine: "netduino2"
      renode:
        enabled: true
        binary: "renode"
        default_machine: "stm32f4"
    resources:
      max_sessions: 100
      max_memory_mb: 4096
      max_cpu_percent: 80
      session_timeout: 3600
    monitoring:
      enabled: true
      prometheus_port: 9090
    storage:
      base_path: "data/storage"
      max_program_size_mb: 100
      max_snapshot_size_mb: 500
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: machineserver-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
